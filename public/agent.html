<!doctype html>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ODIADEV — Talk to Lexi</title>
<style>
  :root{--bg:#0f1020;--card:#171833;--edge:#2a2c5a;--fg:#fff;--mut:#d0d4ff;--pill:#aab1ff;--brand:#5B5BD6}
  *{box-sizing:border-box} body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--fg)}
  .wrap{max-width:720px;margin:40px auto;padding:24px}
  .card{background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  h1{margin:0 0 8px;font-size:26px} p{color:var(--mut)}
  input,button,select{font-size:16px;border-radius:12px;border:1px solid var(--edge);background:#10122b;color:var(--fg);padding:12px 14px}
  button{cursor:pointer;background:var(--brand);border-color:var(--brand)} button:hover{filter:brightness(1.1)}
  .grid{display:grid;grid-template-columns:1fr auto;gap:10px}
  .row{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
  .pill{display:inline-block;padding:6px 10px;border:1px solid var(--edge);border-radius:999px;color:var(--pill);margin:4px 6px 0 0}
  audio{width:100%;margin-top:12px} small{color:#9aa0ff}
  .key{display:grid;grid-template-columns:1fr auto;gap:10px;margin-top:10px}
</style>
<div class="wrap"><div class="card">
  <h1>Talk to Lexi</h1>
  <p>Paste your <b>x-api-key</b>, click <b>Save key</b>, then <b>Play last</b> once to unlock audio. Type → Send.</p>
  <div class="key">
    <input id="apiKey" placeholder="x-api-key (saved locally)"/>
    <button id="saveKey">Save key</button>
  </div>
  <div class="grid" style="margin-top:10px">
    <input id="text" placeholder="Ask me anything..."/>
    <button id="send">Send</button>
  </div>
  <div class="row">
    <select id="voice"><option value="female" selected>Female</option><option value="male">Male</option></select>
    <button id="play">Play last</button><button id="clear">Clear cache</button>
  </div>
  <audio id="player" controls></audio>
  <div id="reply" style="margin-top:8px;"></div>
  <div style="margin-top:12px"><small>Last 5 audios:</small> <span id="cache"></span></div>
</div></div>
<script>
const $ = s => document.querySelector(s);
const KEY="odiadev_api_key", CACHE="odiadev_tts_cache";
const getKey=()=>localStorage.getItem(KEY)||""; const setKey=v=>{localStorage.setItem(KEY,v||"");$("#apiKey").value=v||"";}
const getCache=()=>JSON.parse(localStorage.getItem(CACHE)||"[]"); const setCache=a=>{localStorage.setItem(CACHE,JSON.stringify(a.slice(0,5)));renderCache();}
function renderCache(){const list=getCache();const wrap=$("#cache");wrap.innerHTML="";list.forEach((u,i)=>{const a=document.createElement("a");a.href=u;a.textContent="audio "+(i+1);a.className="pill";a.onclick=e=>{e.preventDefault();play(u)};wrap.appendChild(a);});}
function play(url){const p=$("#player");p.src=url;p.play().catch(()=>{});}
$("#saveKey").onclick=()=>setKey($("#apiKey").value.trim()); $("#apiKey").value=getKey();
$("#send").onclick=async()=>{const text=$("#text").value.trim();if(!text)return;$("#reply").textContent="Thinking...";
  const headers={"Content-Type":"application/json"}; const apiKey=getKey(); if(apiKey) headers["x-api-key"]=apiKey;
  const r=await fetch("/agent",{method:"POST",headers,body:JSON.stringify({text})}); const o=await r.json(); const msg=o.reply||text; $("#reply").textContent=msg;
  const v=$("#voice").value; const a=await fetch("/speak?text="+encodeURIComponent(msg)+"&voice="+encodeURIComponent(v),{headers});
  const b=await a.blob(); const url=URL.createObjectURL(b); play(url); const list=getCache(); list.unshift(url); setCache(list);
}; $("#play").onclick=()=>{const l=getCache(); if(l.length) play(l[0]);}; $("#clear").onclick=()=>{localStorage.removeItem(CACHE); renderCache();}; renderCache();
</script>
